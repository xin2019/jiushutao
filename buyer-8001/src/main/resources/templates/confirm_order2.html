<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>订单确认</title>
    <link rel="stylesheet" th:href="@{/css/bootstrap.css}" href="/css/bootstrap.css">
    <link rel="stylesheet" th:href="@{/css/tao.css}" href="/css/tao.css">
    <script th:src="@{/js/jquery.min.js}" src="/js/jquery.min.js"></script>
    <script th:src="@{/js/bootstrap.js}" src="/js/bootstrap.js"></script>

    <!-- 字体图标 -->
    <link rel="stylesheet" href="/bootstrap3/font-awesome-4.7.0/css/font-awesome.css" th:href="@{/bootstrap3/font-awesome-4.7.0/css/font-awesome.css}"/>
    <link rel="stylesheet" type="text/css" href="/css/layout.css" th:href="@{/css/layout.css}"/>
    <link rel="stylesheet" type="text/css" href="/css/top.css" th:href="@{/css/top.css}"/>
    <link rel="stylesheet" type="text/css" th:href="@{/css/orderConfirm.css}" />
    <link rel="stylesheet" type="text/css" th:href="@{/css/cart.css}" />
    <link rel="stylesheet" type="text/css" href="/css/footer.css" th:href="@{/css/footer.css}"/>
    <link rel="stylesheet" type="text/css" href="/css/product.css" th:href="@{/css/product.css}"/>
    <link rel="stylesheet" type="text/css" href="/css/imgmove.css" th:href="@{/css/imgmove.css}"/>
    <link href="/sweetalert/sweetalert2.min.css" rel="stylesheet" th:href="@{/sweetalert/sweetalert2.min.css}"/>
    <script src="/sweetalert/sweetalert2.min.js" type="text/javascript" th:src="@{/sweetalert/sweetalert2.min.js}"></script>

</head>
<body class="container">
<div th:insert="~{common/header::top-nav}"></div>
<div th:insert="~{common/header::tao-nav}"></div>

<div class="col-md-offset-1 col-md-10">
    <div class="col-md-4">
        <div class="col-md-12 order-bar-undo">
            1.确认订单信息
            <span class="pull-right"><span class="fa fa-chevron-right"></span></span>
        </div>
    </div>
    <div class="col-md-4">
        <div class="col-md-12  order-bar-active">
            2.在线支付
            <span class="pull-right"><span class="fa fa-chevron-right"></span></span>
        </div>
    </div>
    <div class="col-md-4">
        <div class="col-md-12 order-bar-undo">
            3.付款成功
        </div>
    </div>
</div>
<br><br>
    <div >
        <h1 class="text-center">收货人信息</h1><hr>
        <p class="hidden" th:text="${address.getT_address_id()}" id="addressIdText"></p>
       <h3 th:text="'收货人姓名：'+${address.getT_address_name()}"></h3><hr>
       <h3 th:text="'收货人电话：'+${address.getT_address_phone()}"></h3><hr>
       <h3 th:text="'收货人地址：'+${address.getT_buyer_address()}"></h3><hr>
        <hr>
        <div class="panel panel-info">
            <div class="panel-heading">
                <p class="panel-title">订单商品信息：</p>
            </div>
            <div class="panel-body">
                <table class="cart-table" width="100%">
                    <thead>
                    <tr>
                        <th width="15%"></th>
                        <th width="35%">商品</th>
                        <th width="15%">单价</th>
                        <th width="15%">数量</th>
                        <th width="20%">金额</th>
                    </tr>
                    </thead>
                    <tbody class="cart-body" th:each="book:${purchasingBooks}">
                    <tr >
                        <td><img th:src="@{${book.getT_book_photo()}+'/1.jpg'}" class="img-responsive" /></td>
                        <td th:text="${book.getT_book_name()}"></td>
                        <td>¥<span th:text="${book.getT_book_now_price()}"></span></td>
                        <td th:text="1">

                        </td>
                        <td><span th:text="${book.getT_book_now_price()}"></span></td>
                    </tr>
                    </tbody>
                </table>
                <div class="total-bar">
                    &nbsp;
                    <span class="pull-right">共计
									<span id="selectCount" th:text="${quantity}"></span>件 总价¥
									<span id="selectTotal" th:text="${#numbers.formatDecimal(totalPrice,1,'COMMA',2,'POINT')}"></span>元
									</span>
                </div>
            </div>
        </div>
    </div>
<div class="pay-bar">
    <span class="pull-right"><input onclick="settlement()" type="button" value="支付完成" class="btn btn-primary btn-lg link-pay"/></span>
    <span class="pull-right"><input id="btn-cancel" type="button" value="取消订单" class="btn btn-default btn-lg link-pay"/></span>
</div>

<div class="clearfix" th:insert="~{common/footer::foot}"></div>
<script>


    //支付完成
    function settlement() {

        var cookie=document.cookie;
        console.log(cookie);
        var cookieArray=cookie.split(";");
        var userPhone=cookieArray[0].split("=")[1];

        var bookID=null;
        for(var i=0;i<cookieArray.length;i++){
            console.log(cookieArray[i]);
            if(cookieArray[i].search("bookID")!=-1){
                bookID=cookieArray[i].split("=")[1];
                console.log("find bookid==>"+bookID);
            }
        }
        $.ajax({
            url:"/insertNewOrder2",
            data:{
                "phone":userPhone,

            },
            type:"post",
            success:function (data) {
                alert(data)
                if(data==true){
                    window.location.href="/orderSuccess";//////////////////////////进入付款
                }else{
                    alert("添加order记录失败");
                }
            },
            error:function (data) {
                alert("ajax  -btnpay.click失败")
            }
        })

       // 旧版本
        // $.ajax({
        //     url:"/settleBooks",
        //     type:"post",
        //     data:{
        //         "bookid":JSON.stringify(bookids),
        //         "phone":sessionStorage["loginUser"],
        //         "addressid":$('#addressIdText').text()
        //     },
        //     success:function (data) {
        //         if(data!=0){
        //             alert("已完成支付");
        //             window.location.href="/orderSuccess";
        //         }else{
        //             alert("结算失败，请重试")
        //         }
        //     },
        //     error:function (data) {
        //         alert("ajax")
        //     }
        // })

    }


    //支付完成
    $('#btn-pay-success2').click(function () {
        var phone=sessionStorage['loginUser'];
        alert("guada:"+phone);
        // $.ajax({
        //     url:"/insertNewOrder2",
        //     data:{
        //         "phone":phone,
        //
        //     },
        //     type:"post",
        //     success:function (data) {
        //         alert(data)
        //         if(data==true){
        //             window.location.href="/orderSuccess";//////////////////////////进入付款
        //         }else{
        //             alert("添加order记录失败")
        //         }
        //     },
        //     error:function (data) {
        //         alert("ajax  -btnpay.click失败")
        //     }
        // })
        // window.location.href="/orderSuccess"
    })


    // 取消付款
    // $('#btn-cancel').click(function () {
    //
    //
    //     // var loginUser=sessionStorage['loginUser'];
    //     var userID=null;
    //     var bookID=null;
    //     var userPhone=null;
    //     var cookie=document.cookie;
    //     var cookieArray=cookie.split(";");
    //     for(var i=0;i<cookieArray.length;i++){
    //         if(cookieArray[i].search("userID")!=-1){
    //             userID=cookieArray[i].split("=")[1];
    //         }
    //         else if(cookieArray[i].search("bookID")!=-1){
    //             bookID=cookieArray[i].split("=")[1];
    //         }else if(cookieArray[i].search("userPhone")!=-1){
    //             userPhone=cookieArray[i].split("=")[1];
    //         }
    //     }
    //     if(userPhone!=null&&userPhone!=""){
    //         var i=confirm("确认取消订单吗？");
    //         if(i==true){
    //
    //             var url="/cart?phone="+userPhone;
    //             window.location.href=url;
    //         }
    //     }else{
    //         $("#myModal").modal('show');
    //     }
    //     // var url=window.location.href;
    //     // var objs=url.split("/");
    //     // var phone=objs[4].split("=")[1];
    //     // var bookid=objs[5].split("=")[1];
    //     // var quantity=objs[6].split("=")[1];
    //     // var url="/buyer/product/detail?id="+bookid;
    //     // console.log(url)
    //     // window.location.href=url;
    // })


    $('#btn-cancel').click(function () {
        // var loginUser=sessionStorage['loginUser'];
        //
        // if(loginUser!=null&&loginUser!=""){
        //     var url="/cart?phone="+loginUser;
        //     window.location.href=url;
        // }else{
        //     $("#myModal").modal('show');
        // }
        var userID=null;
        var bookID=null;
        var userPhone=null;
        var cookie=document.cookie;
        var cookieArray=cookie.split(";");
        for(var i=0;i<cookieArray.length;i++){
            if(cookieArray[i].search("userID")!=-1){
                userID=cookieArray[i].split("=")[1];
            }
            else if(cookieArray[i].search("bookID")!=-1){
                bookID=cookieArray[i].split("=")[1];
            }else if(cookieArray[i].search("userPhone")!=-1){
                userPhone=cookieArray[i].split("=")[1];
            }
        }
        if(userPhone!=null&&userPhone!=""){
            var i=confirm("确认取消订单吗？");
            if(i==true){
                $.ajax({
                    url:"/updateStatusByBookid4?bookid="+bookID,
                    type:"post",
                    datatype:"json",
                    success:function (data) {
                        $.ajax({
                            url:"/insertNewCancelOrder?phone="+userPhone,
                            type:"post",
                            datatype:"json",
                            success:function (data) {
                                var url="/cart?phone="+userPhone;
                                window.location.href=url;
                            },
                            error:function (data) {
                                alert("ajax=---check-order2->updateStatusByBookid4");
                            }
                        })
                        // var url="/cart?phone="+userPhone;
                        // window.location.href=url;
                    },
                    error:function (data) {
                        alert("ajax=---check-order2->updateStatusByBookid4");
                    }
                })


            }
        }else{
            $("#myModal").modal('show');
        }
    });
</script>
<script th:inline="javascript" th:src="@{/js/login/loginMain.js}" src="/js/login/loginMain.js"></script>
<script>
    var userID=null;
    var bookID=null;
    var userPhone=null;
    var cookie=document.cookie;
    var cookieArray=cookie.split(";");
    for(var i=0;i<cookieArray.length;i++){
        if(cookieArray[i].search("userID")!=-1){
            userID=cookieArray[i].split("=")[1];
        }
        else if(cookieArray[i].search("bookID")!=-1){
            bookID=cookieArray[i].split("=")[1];
        }else if(cookieArray[i].search("userPhone")!=-1){
            userPhone=cookieArray[i].split("=")[1];
        }
    }
    if(userPhone!=null&&userPhone!=""&&userPhone!=undefined){

        $("#githubPanel").addClass("hidden");

        // alert("onload::userphone=>"+userPhone);

        $("#loginSpan").removeAttr("href");
        $("#loginSpan").removeAttr("data-toggle");
        $("#myModal").modal('hide');

        $("#loginSpan").html(userPhone + " 欢迎你!");

        $("#loginSpan").addClass("dropdown-toggle");
        $("#loginSpan").attr("data-toggle","dropdown");
        $("#loginSpan").attr("data-target","#encompassLoginSpan")
        $("#encompassLoginSpan").addClass("dropdown");
    }
</script>
</body>

</html>